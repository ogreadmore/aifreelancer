<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gemini News Aggregator</title>
    <style>
        /* ---------- base & backdrop ---------- */
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:linear-gradient(135deg,#0c0c0c 0%,#1a1a2e 25%,#16213e 50%,#0f0f23 100%);
            background-attachment:fixed;color:#e0e6ed;min-height:100vh;overflow-x:hidden;position:relative
        }
        body::before{
            content:'';position:fixed;inset:0;pointer-events:none;z-index:-1;
            background:
                radial-gradient(600px circle at 20% 30%,rgba(76, 137, 255,.15),transparent 50%),
                radial-gradient(800px circle at 80% 70%,rgba(136, 85, 247,.1),transparent 50%),
                radial-gradient(400px circle at 40% 80%,rgba(64, 204, 128,.1),transparent 50%)
        }
        .container{max-width:1400px;margin:0 auto;padding:20px}
        /* ---------- headings ---------- */
        h1{
            font-size:3.5rem;font-weight:800;margin-bottom:10px;
            background:linear-gradient(135deg,#4c89ff,#8855f7,#40cc80);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
            text-shadow:0 0 40px rgba(76, 137, 255,.3);animation:glow 2s ease-in-out infinite alternate
        }
        @keyframes glow{from{filter:drop-shadow(0 0 10px rgba(76, 137, 255,.4))} to{filter:drop-shadow(0 0 20px rgba(76, 137, 255,.6))}}
        .subtitle{font-size:1.1rem;color:#94a3b8;font-weight:300}
        /* ---------- buttons ---------- */
        .btn{position:relative;overflow:hidden;cursor:pointer;font-weight:600;text-transform:uppercase;
        letter-spacing:.5px;border:none;border-radius:12px;padding:14px 24px;font-size:.9rem;transition:.3s}
        .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
        background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}
        .btn:hover::before{left:100%}.btn-primary{background:linear-gradient(135deg,#3b82f6,#6366f1);color:#fff;
        box-shadow:0 4px 15px rgba(59,130,246,.4)}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(59,130,246,.6)}
        .btn-secondary{background:linear-gradient(135deg,#10b981,#059669);color:#fff;
        box-shadow:0 4px 15px rgba(16,185,129,.4)}.btn-secondary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(16,185,129,.6)}
        .btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;
        box-shadow:0 4px 15px rgba(239,68,68,.4)}.btn-danger:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(239,68,68,.6)}
        .btn-save{background:linear-gradient(135deg,#a855f7,#7c3aed);color:#fff;
        box-shadow:0 4px 15px rgba(168,85,247,.4)}.btn-save:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(168,85,247,.6)}
        /* ---------- collapsible bar ---------- */
        details#settings{margin-bottom:40px}details#settings summary{
        background:rgba(15,23,42,.85);backdrop-filter:blur(16px);
        border:1px solid rgba(51,65,85,.3);border-radius:16px;padding:18px 24px;
        font-size:1.1rem;font-weight:600;cursor:pointer;list-style:none;
        display:flex;align-items:center;gap:10px;user-select:none}
        details#settings summary::-webkit-details-marker{display:none}
        details#settings[open] summary{border-bottom-left-radius:0;border-bottom-right-radius:0}
        details#settings .panel{
        background:rgba(15,23,42,.8);backdrop-filter:blur(20px);
        border:1px solid rgba(51,65,85,.3);border-top:0;border-bottom-left-radius:16px;border-bottom-right-radius:16px;
        padding:30px;animation:fadeIn .4s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        /* ---------- control-panel internals ---------- */
        .control-section{margin-bottom:25px;}.control-section:last-of-type{margin-bottom:0;}
        .control-title{display:flex;align-items:center;gap:10px;margin-bottom:15px;
        font-size:1.2rem;font-weight:600;color:#f1f5f9}.control-title::before{content:'';width:4px;height:20px;background:linear-gradient(135deg,#60a5fa,#a78bfa);border-radius:2px}
        .input-group{display:flex;gap:15px;flex-wrap:wrap;margin-bottom:15px}input[type=text]{
        flex:1;min-width:200px;padding:14px 18px;background:rgba(30,41,59,.8);
        border:1px solid rgba(71,85,105,.5);border-radius:12px;color:#e2e8f0;font-size:.95rem;
        transition:.3s;backdrop-filter:blur(10px)}input[type=text]:focus{outline:none;border-color:#60a5fa;background:rgba(30,41,59,.95);
        box-shadow:0 0 0 3px rgba(96,165,250,.1),0 4px 12px rgba(96,165,250,.15);transform:translateY(-1px)}input::placeholder{color:#64748b}
        /* ---------- list & tag styling ---------- */
        .list-container{background:rgba(15,23,42,.6);backdrop-filter:blur(10px);
        border:1px solid rgba(51,65,85,.3);border-radius:16px;padding:20px;margin-bottom:20px;
        max-height:400px;overflow-y:auto}.list-item{display:flex;justify-content:space-between;align-items:center;
        background:rgba(30,41,59,.6);border:1px solid rgba(71,85,105,.3);
        border-radius:12px;padding:16px 20px;margin-bottom:12px;flex-wrap:wrap;gap:10px;transition:.3s}
        .list-item:hover{background:rgba(30,41,59,.8);border-color:rgba(96,165,250,.5);
        transform:translateX(5px);box-shadow:0 4px 20px rgba(96,165,250,.1)}.item-content{flex:1;min-width:200px;display:flex;align-items:center;gap:8px}
        .item-url{font-weight:500;word-break:break-all}.status-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
        .status-loading{background:#f59e0b;animation:pulse 1s infinite}.status-ok{background:#34d399}.status-fail{background:#ef4444}
        @keyframes pulse{0%{opacity:.6}50%{opacity:1}100%{opacity:.6}}.item-tags{font-size:.85rem;color:#94a3b8;margin-top:4px}
        .item-actions{display:flex;gap:8px;flex-shrink:0}.btn-small{padding:8px 12px;font-size:.8rem}
        .tag-toggle{display:inline-block;padding:10px 16px;margin:5px;border-radius:20px;
        background:rgba(30,41,59,.8);border:1px solid rgba(71,85,105,.5);
        color:#94a3b8;cursor:pointer;font-weight:500;font-size:.9rem;transition:.3s}
        .tag-toggle:hover{background:rgba(30,41,59,.95);border-color:rgba(96,165,250,.5);transform:translateY(-2px)}
        .tag-toggle.active{background:linear-gradient(135deg,#3b82f6,#6366f1);border-color:#3b82f6;color:#fff;box-shadow:0 4px 15px rgba(59,130,246,.4)}
        
        /* ---------- Headlines & Summary Section ---------- */
        .summary-box {
            background: rgba(15, 23, 42, .85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(51, 65, 85, .3);
            border-left: 4px solid #60a5fa;
            border-radius: 16px;
            padding: 25px 30px;
            margin-bottom: 30px;
        }
        .summary-title {
            font-size: 1.5rem; font-weight: 700; color: #f1f5f9; margin-bottom: 15px;
            display: flex; align-items: center; gap: 12px;
        }
        .summary-title::before {
            content: '✨'; font-size: 1.8rem;
        }
        .summary-text {
            font-size: 1rem; color: #b0bec5; line-height: 1.6;
        }
        .summary-text strong { color: #e0e6ed; font-weight: 600; }
        .top-stories-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        @media (min-width: 768px) {
            .top-stories-container { grid-template-columns: 1fr 1fr; }
        }
        @media (min-width: 1200px) {
            .top-stories-container { grid-template-columns: repeat(3, 1fr); }
        }
        .story-list {
            background: rgba(15, 23, 42, .6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, .3);
            border-radius: 16px;
            padding: 25px;
        }
        .story-list h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(51, 65, 85, .5);
        }
        .story-list ol {
            list-style: none;
        }
        .story-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 18px;
            transition: .3s;
            border-radius: 8px;
            padding: 5px;
        }
        .story-item:hover {
            background-color: rgba(30, 41, 59, .4);
        }
        .story-item a {
            text-decoration: none;
        }
        .story-item-num {
            font-size: 1.2rem;
            font-weight: 700;
            color: #60a5fa;
            width: 30px;
            text-align: right;
            flex-shrink: 0;
            padding-top: 2px;
        }
        .story-item-title {
            font-size: .95rem;
            font-weight: 500;
            color: #dbe1e8;
            line-height: 1.4;
            margin-bottom: 4px;
            transition: color .3s;
        }
        .story-item a:hover .story-item-title {
            color: #818cf8;
        }
        .story-item-source {
            font-size: .8rem;
            color: #64748b;
        }
        
        /* ---------- news cards ---------- */
        .news-container{margin-top:40px}.section{margin-bottom:50px;animation:slideUp .6s ease}
        @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .section-header{
            background:linear-gradient(135deg,rgba(15,23,42,.9),rgba(30,41,59,.8));
            backdrop-filter:blur(20px);border:1px solid rgba(51,65,85,.3);border-radius:16px;padding:20px 25px;margin-bottom:20px;position:relative;overflow:hidden
        }
        .section-header::before{content:'';position:absolute;left:0;right:0;top:0;height:2px;background:linear-gradient(90deg,#4c89ff,#8855f7,#40cc80)}
        .section-title{font-size:1.8rem;font-weight:700;color:#f1f5f9;margin:0;text-shadow:0 2px 10px rgba(76, 137, 255,.3)}
        .section-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px}
        .news-card{
            background:rgba(15,23,42,.8);backdrop-filter:blur(20px);border:1px solid rgba(51,65,85,.3);border-radius:16px;
            cursor:pointer;position:relative;overflow:hidden;transition:.4s;
            display:flex; flex-direction:column; padding: 24px;
        }
        .news-card:hover{transform:translateY(-8px);border-color:rgba(76, 137, 255,.6);box-shadow:0 20px 40px rgba(0,0,0,.3),0 0 50px rgba(76, 137, 255,.1)}
        .news-card:hover .card-image{transform: scale(1.05);}
        .card-image-container {
            width: calc(100% + 48px);
            margin: -24px -24px 24px -24px;
            aspect-ratio: 16 / 9;
            overflow: hidden;
            background-color: rgba(30,41,59,.6);
        }
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }
        .card-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* This is essential for the layout */
        }
        .news-title{display:block;margin-bottom:10px;font-size:1.1rem;font-weight:600;color:#f1f5f9;text-decoration:none;line-height:1.4;transition:color .3s}
        .news-title:hover{color:#4c89ff}
        .news-snippet {
            font-size: 0.9rem;
            color: #94a3b8;
            line-height: 1.5;
            margin-bottom: 15px;
            flex-grow: 1; /* Pushes the meta block to the bottom */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .news-meta{
            display:flex;justify-content:space-between;align-items:center;font-size:.85rem;color:#64748b;
            padding-top:15px;border-top:1px solid rgba(51,65,85,.3);
            flex-shrink: 0; /* Prevents meta from shrinking */
        }
        .news-source{font-weight:500;color:#94a3b8}.news-date{color:#64748b}
        .loading{text-align:center;padding:60px 20px;color:#64748b;font-size:1.1rem}
        .loading::after{content:'';display:inline-block;width:20px;height:20px;border-radius:50%;border:2px solid rgba(76, 137, 255,.3);
        border-top-color:#4c89ff;animation:spin 1s linear infinite;margin-left:10px}
        @keyframes spin{to{transform:rotate(360deg)}}.error{color:#f87171;text-align:center;padding:40px 20px;font-size:1rem;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);border-radius:12px;margin:20px 0}
        .empty-state{text-align:center;padding:80px 20px;color:#64748b}.empty-state h3{color:#94a3b8;font-size:1.3rem;margin-bottom:10px}
        /* ---------- responsive ---------- */
        @media(max-width:1199px){
             .top-stories-container { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
        }
        @media(max-width:768px){.container{padding:15px}h1{font-size:2.5rem}.input-group{flex-direction:column}
        .section-grid{grid-template-columns:1fr}.list-item{flex-direction:column;align-items:flex-start}
        .item-actions{width:100%;justify-content:flex-end}}
    </style>
</head>
<body>
<div class="container">
    <div class="header" style="text-align:center;margin-bottom:40px">
        <h1>Gemini News Central</h1>
        <p class="subtitle">Your real-time intelligence feed for Google Gemini</p>
    </div>

    <details id="settings">
        <summary>⚙️ Feed & Section Settings</summary>
        <div class="panel">
            <div class="control-section">
                <div class="control-title">Feed Management</div>
                <div class="input-group">
                    <input id="new-feed-url" type="text" placeholder="RSS or Atom feed URL">
                    <input id="new-feed-tags" type="text" placeholder="Tags (comma-separated)">
                    <button id="add-feed" class="btn btn-primary">Add Feed</button>
                </div>
                <div class="list-container"><ul id="feed-list"></ul></div>
            </div>
            <div class="control-section">
                <div class="control-title">Section Management</div>
                <div class="input-group">
                    <input id="new-section-name" type="text" placeholder="New section/tag name">
                    <button id="add-section" class="btn btn-secondary">Add Section</button>
                    <button id="reset-sections" class="btn btn-danger">Reset Sections</button>
                </div>
                <div class="list-container"><div class="tags-container" id="section-list"></div></div>
            </div>
             <div class="control-section">
                 <div class="control-title">Save Changes</div>
                 <div class="input-group">
                     <button id="save-button" class="btn btn-save" style="width:100%;">Save Aggregator as HTML</button>
                 </div>
            </div>
        </div>
    </details>

    <div id="headlines-section" class="section">
        </div>
    <div id="news-container" class="news-container">
        <div class="loading">Compiling intelligence stream…</div>
    </div>
</div>

<script id="aggregator-script">
// Using an ID for the script tag makes it easier to replace its content
/*FEEDS_START*/let feeds = [
    { "url": "https://blog.google/technology/ai/rss/", "tags": ["Official Google", "Gemini"] },
    { "url": "https://ai.google.dev/blog/rss.xml", "tags": ["Official Google", "Developer"] },
    { "url": "https://cloud.google.com/blog/products/ai-machine-learning/rss", "tags": ["Official Google", "Cloud"] },
    { "url": "https://www.youtube.com/feeds/videos.xml?channel_id=UCwfrxG24uhCo_pWkF_M4iWA", "tags": ["Official YouTube", "Announcements"] },
    { "url": "https://www.youtube.com/feeds/videos.xml?channel_id=UC_x5XG1OV2P6uZZ5FSM9Ttw", "tags": ["Official YouTube", "Developer"] },
    { "url": "https://www.youtube.com/feeds/videos.xml?channel_id=UCJS9pqu9BzkAMNTmzNMNh4w", "tags": ["Official YouTube", "Cloud"] },
    { "url": "https://www.androidpolice.com/tags/google-gemini/rss/", "tags": ["Gemini Sites"] },
    { "url": "https://9to5google.com/guides/google-gemini/feed/", "tags": ["Gemini Sites"] },
    { "url": "https://www.theverge.com/rss/google/index.xml", "tags": ["Gemini Sites"] },
    { "url": "https://www.youtube.com/feeds/videos.xml?channel_id=UCb31_r_p3A-p1s20w_kC4sw", "tags": ["Gemini YouTubers", "News"] },
    { "url": "https://www.youtube.com/feeds/videos.xml?channel_id=UCRlvyf3T22p6s_i1gI3BfMw", "tags": ["Gemini YouTubers", "Tutorials"] },
    { "url": "https://news.google.com/rss/search?q=google+gemini+when:7d&hl=en-US&gl=US&ceid=US:en", "tags": ["Google News"] },
    { "url": "https://rsshub.app/twitter/user/GoogleAI", "tags": ["Social Media"] },
    { "url": "https://rsshub.app/twitter/user/demishassabis", "tags": ["Social Media"] },
    { "url": "https://rsshub.app/twitter/user/jeffdean", "tags": ["Social Media"] },
    { "url": "https://openai.com/news/rss.xml", "tags": ["General AI", "OpenAI"] },
    { "url": "https://www.technologyreview.com/feed/?tag=ai", "tags": ["General AI", "MITTR"] },
    { "url": "https://www.wired.com/feed/category/artificial-intelligence/rss", "tags": ["General AI", "Wired"] },
    { "url": "https://venturebeat.com/category/ai/feed/", "tags": ["General AI", "VentureBeat"] },
    { "url": "https://huggingface.co/blog/feed.xml", "tags": ["General AI", "Hugging Face"] }
];/*FEEDS_END*/
/*SECTIONS_START*/const defaultSectionNames = [    "Official Google",    "Official YouTube",    "Gemini Sites",    "Gemini YouTubers",    "Google News",    "Social Media",    "General AI"];let sections = defaultSectionNames.map(n=>({name: n, active: true}));/*SECTIONS_END*/

/* status map: {url: {state:'loading'|'ok'|'fail', error:''}} */
const feedStatus = {};
/* ---------- DOM refs ---------- */
const feedListEl = document.getElementById('feed-list');
const sectionListEl = document.getElementById('section-list');
const headlinesContainer = document.getElementById('headlines-section');
const newsContainer = document.getElementById('news-container');
const newFeedUrlInput = document.getElementById('new-feed-url');
const newFeedTagsInput = document.getElementById('new-feed-tags');
const newSectionInput = document.getElementById('new-section-name');
const addFeedBtn = document.getElementById('add-feed');
const addSectionBtn = document.getElementById('add-section');
const resetSectionsBtn = document.getElementById('reset-sections');
const saveBtn = document.getElementById('save-button');

/* ---------- UI helpers ---------- */
function renderFeedList() {
    feedListEl.innerHTML = '';
    if (!feeds.length) {
        feedListEl.innerHTML = '<div class="empty-state"><h3>No feeds added</h3><p>Add feeds to get started.</p></div>';
        return;
    }
    // Sort feeds alphabetically by URL for consistency
    feeds.sort((a, b) => a.url.localeCompare(b.url));
    feeds.forEach((feed, i) => {
        const li = document.createElement('li');
        li.className = 'list-item';
        const content = document.createElement('div');
        content.className = 'item-content';

        const status = feedStatus[feed.url]?.state || 'loading';
        const dot = document.createElement('span');
        dot.className = 'status-dot status-' + status;
        if (feedStatus[feed.url]?.error) dot.title = feedStatus[feed.url].error;

        const urlDiv = document.createElement('div');
        urlDiv.className = 'item-url';
        urlDiv.textContent = feed.url;
        content.append(dot, urlDiv);

        const tagsDiv = document.createElement('div');
        tagsDiv.className = 'item-tags';
        tagsDiv.textContent = 'Tags: ' + feed.tags.join(', ');

        const wrap = document.createElement('div');
        wrap.append(content, tagsDiv);

        const actions = document.createElement('div');
        actions.className = 'item-actions';
        const edit = document.createElement('button');
        edit.className = 'btn btn-secondary btn-small';
        edit.textContent = 'Edit';
        edit.onclick = () => {
            const t = prompt('Edit Tags (comma-separated)', feed.tags.join(', '));
            if (t !== null) {
                feed.tags = t.split(',').map(x => x.trim()).filter(Boolean);
                renderFeedList();
                renderSectionList();
                loadNews();
            }
        };
        const remove = document.createElement('button');
        remove.className = 'btn btn-danger btn-small';
        remove.textContent = 'Remove';
        remove.onclick = () => {
            feeds.splice(i, 1);
            delete feedStatus[feed.url];
            renderFeedList();
            loadNews();
        };
        actions.append(edit, remove);

        li.append(wrap, actions);
        feedListEl.appendChild(li);
    });
}
function renderSectionList() {
    sectionListEl.innerHTML = '';
    const allTags = new Set(defaultSectionNames.concat(sections.map(s => s.name)));
    const uniqueSections = Array.from(allTags).map(name => {
        const existing = sections.find(s => s.name === name);
        return existing || { name, active: true };
    });
    sections = uniqueSections;
    sections.sort((a,b) => (defaultSectionNames.indexOf(a.name) > -1 ? defaultSectionNames.indexOf(a.name) : Infinity) - (defaultSectionNames.indexOf(b.name) > -1 ? defaultSectionNames.indexOf(b.name) : Infinity));

    sections.forEach((sec, i) => {
        const tag = document.createElement('span');
        tag.className = 'tag-toggle' + (sec.active ? ' active' : '');
        tag.textContent = sec.name;
        tag.onclick = () => {
            sec.active = !sec.active;
            renderSectionList();
            loadNews();
        };
        if (!defaultSectionNames.includes(sec.name)) {
            tag.ondblclick = e => {
                e.stopPropagation();
                if (confirm(`Remove custom section "${sec.name}"?`)) {
                    sections.splice(i, 1);
                    renderSectionList();
                    loadNews();
                }
            };
            tag.title = 'Double-click to remove custom section';
        }
        sectionListEl.appendChild(tag);
    });
}
/* ---------- event hooks ---------- */
addFeedBtn.onclick = () => {
    const url = newFeedUrlInput.value.trim();
    const tags = newFeedTagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
    if (!url) { alert('Enter a feed URL'); return; }
    if (feeds.some(f => f.url === url)) { alert('Feed already added'); return; }
    feeds.push({ url, tags });
    newFeedUrlInput.value = '';
    newFeedTagsInput.value = '';
    feedStatus[url] = { state: 'loading' };
    renderFeedList();
    renderSectionList();
    loadNews();
};
addSectionBtn.onclick = () => {
    const name = newSectionInput.value.trim();
    if (!name) { alert('Enter a section name'); return; }
    if (sections.some(s => s.name.toLowerCase() === name.toLowerCase())) { alert('Section already exists'); return; }
    sections.push({ name, active: true });
    newSectionInput.value = '';
    renderSectionList();
    loadNews();
};
resetSectionsBtn.onclick = () => {
    if (confirm('Reset sections to default and remove custom ones?')) {
        sections = defaultSectionNames.map(n => ({ name: n, active: true }));
        renderSectionList();
        loadNews();
    }
};
saveBtn.onclick = () => {
    try {
        let html = document.documentElement.outerHTML;
        const feedsString = `let feeds = ${JSON.stringify(feeds, null, 4)};`;
        const sectionsString = `const defaultSectionNames = ${JSON.stringify(defaultSectionNames, null, 4)};\nlet sections = ${JSON.stringify(sections, null, 4)};`;
                const scriptTag = document.getElementById('aggregator-script');
        const scriptContent = scriptTag.innerHTML;
        const feedsRegex = /\/\*FEEDS_START\*\/([\s\S]*?)\/\*FEEDS_END\*\//;
        const sectionsRegex = /\/\*SECTIONS_START\*\/([\s\S]*?)\/\*SECTIONS_END\*\//;
        let newScriptContent = scriptContent.replace(feedsRegex, `/*FEEDS_START*/let feeds = ${JSON.stringify(feeds, null, 4)};/*FEEDS_END*/`);
        newScriptContent = newScriptContent.replace(sectionsRegex, `/*SECTIONS_START*/${sectionsString}/*SECTIONS_END*/`);
        html = html.replace(scriptContent, newScriptContent);
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gemini-news-aggregator.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error("Save failed:", error);
        alert("Could not save the file. See the console for more details.");
    }
};

/* ---------- feed fetching ---------- */
const CORS_PROXY = 'https://corsproxy.io/?';

async function fetchFeed(feed) {
    feedStatus[feed.url] = { state: 'loading' };
    renderFeedList();
    try {
        const response = await fetch(CORS_PROXY + encodeURIComponent(feed.url));
        if (!response.ok) throw new Error(`Fetch failed with status ${response.status} for ${feed.url}`);
        const xml = await response.text();
        const doc = new DOMParser().parseFromString(xml, 'application/xml');
        if (doc.querySelector('parsererror')) throw new Error(`XML parse error for ${feed.url}`);
        const nodes = [...doc.querySelectorAll('item, entry')];
        const items = nodes.map(n => {
            const title = n.querySelector('title')?.textContent?.trim() || 'Untitled';
            let link = '#';
            const linkEl = n.querySelector('link[rel="alternate"]') || n.querySelector('link');
            if (linkEl) link = linkEl.getAttribute('href') || linkEl.textContent || '#';
            const dateText = n.querySelector('pubDate')?.textContent?.trim() || n.querySelector('updated')?.textContent?.trim() || n.querySelector('published')?.textContent?.trim();
            let pubDate = new Date(dateText);
            if (isNaN(pubDate)) pubDate = new Date();
            const sourceUrl = new URL(CORS_PROXY + feed.url);
            let sourceHost = sourceUrl.hostname.includes('youtube.com') ? 'youtube.com' : (new URL(feed.url)).hostname.replace('www.','');

            const rawHtml = n.querySelector('content\\:encoded, content')?.textContent || n.querySelector('description')?.textContent || '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = rawHtml;
            let imageUrl = null;
            const mediaThumbnail = n.querySelector('media\\:thumbnail, thumbnail');
            if (mediaThumbnail) {
                imageUrl = mediaThumbnail.getAttribute('url');
            } else {
                const img = tempDiv.querySelector('img');
                if (img) imageUrl = img.src;
            }
            let cleanText = tempDiv.textContent.replace(/The post.*appeared first on.*/i, '').trim();
            if (cleanText.length > 150) {
                cleanText = cleanText.substring(0, 150).replace(/\s\w+$/, '') + '…';
            } else if (cleanText.length === 0) {
                cleanText = 'No text preview available.';
            }
            return { title, link, pubDate, imageUrl, description: cleanText, source: sourceHost, tags: feed.tags };
        }).filter(i => i.title && i.link);
        feedStatus[feed.url] = { state: 'ok' };
        renderFeedList();
        return items;
    } catch (err) {
        console.error(err);
        feedStatus[feed.url] = { state: 'fail', error: err?.message || 'Unknown error' };
        renderFeedList();
        return [];
    }
}

/* ---------- Article Ranking & Filtering ---------- */
function rankAndFilterArticles(articles) {
    const now = new Date();

    const articleMap = new Map();
    articles.forEach(article => {
        if (articleMap.has(article.link)) {
            const existing = articleMap.get(article.link);
            const mergedTags = new Set([...existing.tags, ...article.tags]);
            existing.tags = Array.from(mergedTags);
            if (article.pubDate > existing.pubDate) {
                existing.pubDate = article.pubDate;
            }
        } else {
            articleMap.set(article.link, { ...article, tags: [...article.tags] });
        }
    });
    const uniqueArticles = Array.from(articleMap.values());

    const sourceWeights = { 'blog.google': 1.8, 'ai.google.dev': 1.7, 'cloud.google.com': 1.5, 'openai.com': 1.4 };
    const keywordWeights = { 'introducing': 5, 'announces': 5, 'release': 4, 'new': 3, 'gemini': 2 };
    
    const ranked = uniqueArticles.map(article => {
        let score = 0;
        const titleLower = article.title.toLowerCase();
        score += sourceWeights[article.source] || 1;
        for (const keyword in keywordWeights) {
            if (titleLower.includes(keyword)) score += keywordWeights[keyword];
        }
        const hoursAgo = (now - article.pubDate) / (1000 * 60 * 60);
        score += Math.max(0, 10 - hoursAgo * 0.1);
        article.score = score;
        return article;
    }).sort((a, b) => b.score - a.score);

    const dayMarker = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    const weekMarker = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const monthMarker = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

    const articlesToday = ranked.filter(a => a.pubDate >= dayMarker);
    const articlesThisWeek = ranked.filter(a => a.pubDate >= weekMarker);
    const articlesThisMonth = ranked.filter(a => a.pubDate >= monthMarker);

    return { today: articlesToday, week: articlesThisWeek, month: articlesThisMonth, all: ranked };
}

/* ---------- NEW: Insightful Summary Generation ---------- */
function generateInsightfulSummary(articlesToday) {
    if (articlesToday.length === 0) {
        return "No significant AI news has been published in the last 24 hours. It's a quiet day.";
    }

    const topStory = articlesToday[0];
    let summary = `The leading story today is <strong>${topStory.title}</strong> from ${topStory.source}. `;

    // A list of common English words to ignore when looking for themes.
    const stopWords = new Set(['a', 'an', 'the', 'and', 'or', 'in', 'on', 'for', 'with', 'to', 'from', 'of', 'as', 'its', 'is', 'i', 'me', 'my', 'we', 'our', 'you', 'your', 'he', 'she', 'it', 'they', 'them', 'their', 'what', 'which', 'who', 'whom', 'this', 'that', 'these', 'those', 'am', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing', 'but', 'if', 'because', 'while', 'at', 'by', 'up', 'down', 'out', 'about', 'more', 'how', 'when', 'where', 'why', 'all', 'any', 'both', 'each', 'few', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 's', 't', 'can', 'will', 'just', 'don', 'should', 'now', 'its', 'into', 'not', 'get', 'one', 'two', 'again']);

    const wordFreq = new Map();
    // Analyze the top 5 articles for themes
    articlesToday.slice(0, 5).forEach(article => {
        const words = article.title.toLowerCase().replace(/[^a-z0-9\s]/g, '').split(/\s+/);
        words.forEach(word => {
            if (word && !stopWords.has(word) && isNaN(word)) { // Check if it's not a number
                wordFreq.set(word, (wordFreq.get(word) || 0) + 1);
            }
        });
    });

    // Find words that appear in more than one headline to identify themes
    const themes = [];
    for (let [word, count] of wordFreq.entries()) {
        if (count > 1) {
            themes.push(word);
        }
    }

    const topThemes = themes.slice(0, 3);

    if (topThemes.length > 0) {
        summary += `Recurring themes across the headlines include <strong>${topThemes.join('</strong>, <strong>')}</strong>. `;
    } else if (articlesToday.length > 1) {
        summary += "Discussions today span a diverse range of topics without a single overarching theme. ";
    }

    summary += `In total, ${articlesToday.length} relevant ${articlesToday.length === 1 ? 'article' : 'articles'} have been indexed in the last 24 hours.`;

    return summary;
}


/* ---------- Headline Section Rendering ---------- */
function renderHeadlineSection(rankedToday, rankedWeek, rankedMonth) {
    headlinesContainer.innerHTML = ''; 
    
    // Generate and render the new insightful summary
    const summary = document.createElement('div');
    summary.className = 'summary-box';
    const summaryText = generateInsightfulSummary(rankedToday);
    summary.innerHTML = `
        <div class="summary-title">Today's AI Briefing</div>
        <p class="summary-text">${summaryText}</p>
    `;
    headlinesContainer.appendChild(summary);

    // Render the top story lists
    const topStoriesContainer = document.createElement('div');
    topStoriesContainer.className = 'top-stories-container';
    topStoriesContainer.innerHTML = `
        <div class="story-list">${renderStoryList('Top 5 of the Day', rankedToday.slice(0, 5))}</div>
        <div class="story-list">${renderStoryList('Top 10 of the Week', rankedWeek.slice(0, 10))}</div>
        <div class="story-list">${renderStoryList('Top 10 of the Month', rankedMonth.slice(0, 10))}</div>
    `;
    headlinesContainer.appendChild(topStoriesContainer);
}

function renderStoryList(title, articles) {
    if (articles.length === 0) {
        return `<h3>${title}</h3><p class="empty-state" style="padding: 20px 0;">No stories found.</p>`;
    }
    const itemsHtml = articles.map((a, i) => `
        <li class="story-item">
            <span class="story-item-num">${i + 1}.</span>
            <div>
                <a href="${a.link}" target="_blank" rel="noopener noreferrer">
                    <div class="story-item-title">${a.title}</div>
                </a>
                <div class="story-item-source">${a.source} • ${formatDate(a.pubDate)}</div>
            </div>
        </li>
    `).join('');
    return `<h3>${title}</h3><ol>${itemsHtml}</ol>`;
}


/* ---------- news loading ---------- */
async function loadNews() {
    newsContainer.innerHTML = `<div class="loading">Compiling intelligence stream…</div>`;
    headlinesContainer.innerHTML = ''; 

    try {
        const results = await Promise.allSettled(feeds.map(fetchFeed));
        const allArticles = results.filter(r => r.status === 'fulfilled').flatMap(r => r.value);
        newsContainer.innerHTML = '';

        if (!allArticles.length) {
            headlinesContainer.innerHTML = '<div class="empty-state"><h3>Could not load any feeds.</h3><p>The proxy may be down or your network is offline.</p></div>';
            newsContainer.innerHTML = '<div class="empty-state"><h3>No articles found</h3><p>Check your feeds or network connection.</p></div>';
            return;
        }

        const { today: rankedToday, week: rankedWeek, month: rankedMonth, all: allRanked } = rankAndFilterArticles(allArticles);
        renderHeadlineSection(rankedToday, rankedWeek, rankedMonth);

        const activeSections = sections.filter(s => s.active);
        if (!activeSections.length) {
            newsContainer.innerHTML = '<div class="empty-state"><h3>No active sections</h3><p>Enable a section from the settings to see news.</p></div>';
            return;
        }

        activeSections.forEach(sec => {
            const kw = sec.name.toLowerCase();
            const sectionArticles = allRanked.filter(a => {
                return a.tags.some(t => t.toLowerCase().includes(kw));
            }).sort((a, b) => b.pubDate - a.pubDate); // Sort by date for section view

            if (!sectionArticles.length) return;

            const sectionEl = document.createElement('div');
            sectionEl.className = 'section';
            sectionEl.innerHTML = `<div class="section-header"><h2 class="section-title">${sec.name} (${sectionArticles.length})</h2></div>`;
            const grid = document.createElement('div');
            grid.className = 'section-grid';
            sectionArticles.slice(0, 18).forEach(a => {
                const card = document.createElement('div');
                card.className = 'news-card';
                card.onclick = () => window.open(a.link, '_blank', 'noopener,noreferrer');
                const imageHtml = a.imageUrl ? `<div class="card-image-container"><img src="${a.imageUrl}" class="card-image" alt="Article thumbnail" loading="lazy" onerror="this.parentElement.style.display='none'"></div>` : '';
                const contentHtml = `
                    <div class="card-content">
                        <a class="news-title" href="${a.link}" target="_blank" rel="noopener noreferrer">${a.title}</a>
                        <p class="news-snippet">${a.description}</p>
                        <div class="news-meta">
                            <span class="news-source">${a.source}</span>
                            <span class="news-date">${formatDate(a.pubDate)}</span>
                        </div>
                    </div>`;
                card.innerHTML = imageHtml + contentHtml;
                grid.appendChild(card);
            });
            sectionEl.appendChild(grid);
            newsContainer.appendChild(sectionEl);
        });

        if (!newsContainer.children.length) {
            newsContainer.innerHTML = '<div class="empty-state"><h3>No matches found</h3><p>Enable more sections or add different feeds to see articles.</p></div>';
        }
    } catch (err) {
        console.error(err);
        newsContainer.innerHTML = '<div class="error">Failed to load news. Check the console for details.</div>';
    }
}

/* ---------- util ---------- */
function formatDate(d) {
    const now = new Date();
    const mins = Math.floor((now - d) / 60000);
    if (mins < 1) return 'Just now';
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    const days = Math.floor(hrs / 24);
    if (days === 1) return 'Yesterday';
    if (days < 7) return `${days}d ago`;
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

/* ---------- init ---------- */
(function init() {
    feeds.forEach(f => feedStatus[f.url] = { state: 'loading' });
    renderFeedList();
    renderSectionList();
    loadNews();
    setInterval(loadNews, 15 * 60 * 1000); // Auto-refresh every 15 minutes
})();
</script>
</body>
</html>
